<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>历史战绩 - CS2 内战匹配系统</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="header">
    <div class="header-content">
      <a href="lobby.html" class="logo">CS2 BP系统</a>
      <div class="user-info">
        <span class="user-name" id="userName"></span>
        <span class="user-elo" id="userElo"></span>
        <button class="btn btn-secondary" onclick="navigate('lobby.html')">返回大厅</button>
      </div>
    </div>
  </div>
  
  <div class="container">
    <div class="card">
      <h2 class="card-title">我的战绩</h2>
      
      <div id="playerInfo" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px;">
        <div class="stat-item">
          <div class="stat-label">总场次</div>
          <div class="stat-value" id="totalMatches">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">胜场</div>
          <div class="stat-value" id="wins" style="color: var(--success-color);">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">败场</div>
          <div class="stat-value" id="losses" style="color: var(--danger-color);">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">胜率</div>
          <div class="stat-value" id="winRate">0%</div>
        </div>
      </div>
    </div>
    
    <div class="card">
      <h2 class="card-title">比赛历史</h2>
      <div id="historyList" class="history-list">
        <p style="text-align: center; color: var(--gray-500);">加载中...</p>
      </div>
    </div>
  </div>
  
  <script src="js/localStorage-db.js"></script>
  <script src="js/api.js"></script>
  <script src="js/utils.js"></script>
  <script>
    if (!checkLogin()) throw new Error('未登录');
    
    const user = User.get();
    document.getElementById('userName').textContent = user.nickname;
    document.getElementById('userElo').textContent = `ELO: ${user.elo || 1000}`;
    
    // 初始化
    async function init() {
      showLoading('加载中...');
      
      // 获取玩家信息
      const playerResult = await API.history.getPlayerInfo(user.player_id);
      if (playerResult.code === 0) {
        const player = playerResult.data.player;
        document.getElementById('totalMatches').textContent = player.total_matches || 0;
        document.getElementById('wins').textContent = player.wins || 0;
        document.getElementById('losses').textContent = player.losses || 0;
        
        const winRate = player.total_matches > 0 
          ? Math.round((player.wins / player.total_matches) * 100)
          : 0;
        document.getElementById('winRate').textContent = winRate + '%';
        
        // 更新 ELO
        Storage.set('elo', player.elo);
        document.getElementById('userElo').textContent = `ELO: ${player.elo}`;
      }
      
      // 获取历史记录
      const historyResult = await API.history.getPlayer(user.player_id);
      
      hideLoading();
      
      if (historyResult.code === 0) {
        displayHistory(historyResult.data);
      } else {
        showToast('获取历史记录失败', 'error');
      }
    }
    
    // 显示历史记录
    function displayHistory(history) {
      const historyList = document.getElementById('historyList');
      
      if (history.length === 0) {
        historyList.innerHTML = '<p style="text-align: center; color: var(--gray-500);">暂无战绩</p>';
        return;
      }
      
      historyList.innerHTML = history.map(item => {
        const isWin = (item.team === 'A' && item.match_winner === 'A') || 
                     (item.team === 'B' && item.match_winner === 'B');
        const isDraw = item.match_winner === 'draw';
        
        let resultClass = '';
        let resultText = '';
        
        if (isDraw) {
          resultClass = '';
          resultText = '平局';
        } else if (isWin) {
          resultClass = 'win';
          resultText = '胜利';
        } else {
          resultClass = 'loss';
          resultText = '失败';
        }
        
        const eloChangeClass = item.elo_change >= 0 ? 'positive' : 'negative';
        
        return `
          <div class="history-item ${resultClass}">
            <div class="history-header">
              <div>
                <strong>${getMapName(item.match_map)}</strong>
                <span style="margin-left: 12px; color: var(--gray-600);">
                  ${item.score_a} : ${item.score_b}
                </span>
                <span style="margin-left: 12px; font-weight: 600; color: ${isWin ? 'var(--success-color)' : (isDraw ? 'var(--gray-600)' : 'var(--danger-color)')}">
                  ${resultText}
                </span>
              </div>
              <div class="history-date">${formatDate(item.match_date)}</div>
            </div>
            
            <div class="history-stats">
              <div class="stat-item">
                <div class="stat-label">击杀</div>
                <div class="stat-value">${item.kills}</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">死亡</div>
                <div class="stat-value">${item.deaths}</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">K/D</div>
                <div class="stat-value">${item.kd_ratio.toFixed(2)}</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">ELO变化</div>
                <div class="stat-value elo-change ${eloChangeClass}">
                  ${item.elo_change > 0 ? '+' : ''}${item.elo_change}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // 初始化
    init();
  </script>
</body>
</html>

