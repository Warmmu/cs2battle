# BP功能修复更新说明

## 更新日期
2024年（根据测试反馈）

## 修复的问题

### 问题1：BP图不能同步 ✅
**问题描述**：玩家在BP时，其他玩家看不到实时更新的地图选择状态。

**解决方案**：
- 在BP页面添加了轮询机制（每2秒刷新一次）
- 实时同步BP状态、投票进度和可用地图
- 页面卸载时自动停止轮询

**修改文件**：
- `miniprogram/pages/bp/index.js` - 添加 `startPolling()` 和 `stopPolling()` 方法

### 问题2：队伍权限混乱 ✅
**问题描述**：A队Ban完后，B队在Ban时A队成员也能参与操作。

**解决方案**：
- 添加队伍权限验证
- 云函数检查操作者是否在当前轮到的队伍中
- 前端判断当前玩家是否可以投票，非己方回合禁用操作
- 地图卡片根据是否可操作显示不同样式

**修改文件**：
- `cloudfunctions/bp/index.js` - 在 `doBP()` 函数中添加权限验证
- `miniprogram/pages/bp/index.js` - 添加 `canVote` 状态判断
- `miniprogram/pages/bp/index.wxml` - 地图卡片添加 `not-my-turn` 样式类
- `miniprogram/pages/bp/index.wxss` - 非己方回合地图显示灰色

### 问题3：BP应该是队内投票 ✅
**问题描述**：单人点击就能Ban/Pick，应该改为队内投票制。

**解决方案**：
- 实现队内投票机制
- 需要队伍半数以上玩家同意才能执行BP
- 显示实时投票进度
- 投票达到要求后自动执行并进入下一轮

**投票规则**：
- 所需票数 = ⌈队伍人数 / 2⌉（向上取整）
- 例如：3人队伍需要2票，5人队伍需要3票
- 投票记录在 `bp_records` 集合的 `current_votes` 字段中
- 每轮BP完成后自动清空投票

**修改文件**：
- `cloudfunctions/bp/index.js`
  - 添加 `current_votes` 字段记录投票
  - 修改 `doBP()` 函数实现投票逻辑
  - 统计票数并在达到要求时执行BP
- `miniprogram/pages/bp/index.js`
  - 添加投票进度显示
  - 处理等待投票状态
- `miniprogram/pages/bp/index.wxml`
  - 显示投票进度 `voteProgress`
  - 提示队员投票
- `miniprogram/pages/bp/index.wxss`
  - 添加投票状态样式

## 额外优化

### 关闭个人测试模式 ✅
**原因**：测试反馈表明单人测试模式已不需要，为确保游戏体验，要求至少2人。

**修改内容**：
- 房间准备至少需要2人
- 匹配至少需要2人
- 更新提示文案

**修改文件**：
- `cloudfunctions/match/index.js` - 最少玩家数改为2
- `cloudfunctions/room/index.js` - 准备检查改为至少2人
- `miniprogram/pages/lobby/index.wxml` - 更新提示文案

## 新增功能

### 1. 队伍显示
- 在BP页面顶部显示玩家所在队伍（"您在 A 队"）
- 清晰标识当前操作轮次

### 2. 实时投票进度
- 显示当前投票进度（例如：2/3）
- 投票成功后自动进入下一轮
- 投票中显示提示信息

### 3. 视觉优化
- 非己方回合的地图显示为灰色
- 投票进度使用绿色徽章显示
- 清晰的队伍颜色区分（A队蓝色、B队紫色）

## 使用说明

### BP流程
1. **队伍分配**：匹配完成后自动分为A队和B队
2. **轮次顺序**：A队Ban → B队Ban → A队Pick
3. **投票机制**：
   - 轮到己方队伍时，队员可点击地图投票
   - 达到半数以上同意即执行
   - 自动进入下一轮
4. **实时同步**：所有玩家每2秒同步一次状态

### 投票示例
假设A队有3人：
- 玩家1投票 inferno
- 玩家2投票 inferno（2票，达到要求）
- 自动Ban掉 inferno，进入B队Ban环节

假设B队有5人：
- 玩家1投票 mirage
- 玩家2投票 dust2
- 玩家3投票 mirage（2票，未达到要求）
- 玩家4投票 mirage（3票，达到要求）
- 自动Ban掉 mirage，进入A队Pick环节

## 部署说明

需要重新上传并部署以下云函数：
1. `bp` - BP投票和权限验证
2. `match` - 关闭单人测试模式
3. `room` - 最少2人准备要求

```bash
# 在微信开发者工具中
# 右键 cloudfunctions/bp 目录
# 选择"上传并部署：云端安装依赖"

# 对 match 和 room 重复上述操作
```

## 测试建议

1. **2人测试**：
   - 两人加入房间
   - 测试A队Ban（需要1票）
   - 测试B队Ban（需要1票）
   - 测试A队Pick（需要1票）

2. **多人测试**（4-6人）：
   - 测试投票机制
   - 验证半数要求
   - 测试实时同步

3. **权限测试**：
   - A队玩家在B队Ban时尝试操作（应被拒绝）
   - 验证地图显示状态

## 数据库变更

### bp_records 集合新增字段
```javascript
{
  current_votes: {}, // 投票记录 { player_id: map }
  // 其他已有字段...
}
```

## 注意事项

⚠️ **重要**：
- 必须重新部署 `bp`、`match`、`room` 三个云函数
- 建议清空测试数据重新测试
- 确保所有玩家都更新到最新版本

## 后续优化建议

1. **投票可视化**：显示每个玩家的投票选择
2. **投票倒计时**：超时自动执行多数票
3. **BP历史**：记录每次投票的详细信息
4. **队长模式**：可选的队长独自决定模式

