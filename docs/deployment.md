# CS2 内战匹配系统 - 部署指南

## 📋 部署前准备

### 1. 环境要求

- 微信开发者账号
- 已认证的小程序（或测试号）
- 已开通云开发环境

### 2. 开发工具

- 微信开发者工具 (最新稳定版)
- Node.js (建议 14.x 或以上)

## 🚀 部署步骤

### 第一步：克隆项目

```bash
git clone <项目地址>
cd cs2
```

### 第二步：配置云开发环境

1. 打开微信开发者工具
2. 导入项目
3. 点击"云开发"按钮
4. 创建云开发环境（如果还没有）
5. 记录环境 ID

### 第三步：创建数据库集合

在云开发控制台 → 数据库中创建以下集合：

#### 必需集合列表

| 集合名 | 说明 |
|--------|------|
| `players` | 玩家信息 |
| `rooms` | 房间信息 |
| `bp_records` | BP 记录 |
| `matches` | 比赛记录 |
| `player_stats` | 玩家比赛统计 |
| `elo_history` | ELO 历史 |

#### 权限配置

建议设置权限为：
- 所有用户可读
- 仅创建者可读写（更严格）

或根据需要自定义权限。

### 第四步：部署云函数

#### 方法一：通过微信开发者工具

1. 在开发者工具中右键每个云函数文件夹
2. 选择"上传并部署：云端安装依赖"

需要部署的云函数：
- ✅ register
- ✅ room
- ✅ match
- ✅ bp
- ✅ submit
- ✅ history

#### 方法二：使用命令行（可选）

```bash
# 进入云函数目录
cd cloudfunctions/register
npm install
# 返回项目根目录并使用工具上传

# 对每个云函数重复此步骤
```

### 第五步：配置云函数环境

确保每个云函数的 `config.json` 正确配置：

```json
{
  "permissions": {
    "openapi": []
  }
}
```

### 第六步：测试部署

1. 在开发者工具中点击"预览"
2. 使用微信扫码
3. 测试注册功能
4. 测试房间创建
5. 测试完整流程

## 🔍 验证部署

### 检查清单

- [ ] 所有云函数已上传
- [ ] 数据库集合已创建
- [ ] 可以成功注册玩家
- [ ] 可以创建和加入房间
- [ ] 可以进行匹配和 BP
- [ ] 可以提交比赛结果
- [ ] ELO 正确计算
- [ ] 排行榜显示正常

### 常见问题

#### 1. 云函数调用失败

**问题**：调用云函数返回错误

**解决方案**：
- 检查云函数是否正确部署
- 查看云函数日志
- 确认环境 ID 配置正确

#### 2. 数据库写入失败

**问题**：数据无法写入数据库

**解决方案**：
- 检查数据库权限配置
- 确认集合已创建
- 查看云函数日志

#### 3. 页面显示空白

**问题**：页面加载但显示空白

**解决方案**：
- 检查控制台错误信息
- 确认云开发环境已初始化
- 检查网络连接

## 📊 数据库索引优化（可选）

为了提高查询性能，建议添加以下索引：

### players 集合
```javascript
// nickname 索引
{ "nickname": 1 }

// elo 降序索引（用于排行榜）
{ "elo": -1 }

// created_at 索引
{ "created_at": -1 }
```

### matches 集合
```javascript
// date 降序索引
{ "date": -1 }

// teamA 索引
{ "teamA": 1 }

// teamB 索引
{ "teamB": 1 }

// status 索引
{ "status": 1 }
```

### player_stats 集合
```javascript
// match_id 索引
{ "match_id": 1 }

// player_id 索引
{ "player_id": 1 }

// 组合索引
{ "player_id": 1, "created_at": -1 }
```

## 🔒 安全建议

1. **数据库权限**
   - 使用最小权限原则
   - 敏感数据加密存储

2. **云函数安全**
   - 验证输入参数
   - 防止 SQL 注入（虽然是 NoSQL）
   - 限制请求频率

3. **用户数据**
   - 不存储敏感个人信息
   - 遵守数据保护法规

## 📈 性能优化

1. **数据库查询**
   - 使用索引
   - 限制返回字段
   - 分页加载

2. **云函数**
   - 避免冗余查询
   - 使用缓存（如适用）
   - 优化算法复杂度

3. **小程序端**
   - 图片压缩
   - 按需加载
   - 使用骨架屏

## 🔄 更新部署

### 更新云函数

1. 修改云函数代码
2. 右键云函数目录
3. 选择"上传并部署"

### 更新小程序代码

1. 修改小程序代码
2. 点击"上传"
3. 提交审核（如需发布）

## 📱 发布上线

1. 在微信开发者工具中点击"上传"
2. 填写版本号和备注
3. 登录小程序后台
4. 提交审核
5. 等待审核通过
6. 发布上线

## 🛠️ 监控与维护

### 日志查看

- 云开发控制台 → 云函数 → 日志
- 监控异常调用
- 分析性能瓶颈

### 数据备份

- 定期导出数据库数据
- 备份重要配置

### 性能监控

- 查看云函数调用次数
- 监控数据库读写次数
- 优化高频操作

## 📞 技术支持

如遇到部署问题：

1. 查看微信云开发官方文档
2. 检查项目 Issues
3. 提交新 Issue 描述问题

---

祝部署顺利！🎉

