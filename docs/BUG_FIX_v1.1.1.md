# Bug修复说明 v1.1.1

## 修复日期
2024年

## 修复的Bug

### Bug #1: 大厅页面看不到房间信息 ✅

**问题描述：**
- 用户在加入房间前无法看到当前房间状态
- 不知道房间里有多少人
- 只能盲目点击"加入房间"

**影响：**
- 用户体验不佳
- 无法判断是否有房间在等待
- 不知道房间人数情况

**解决方案：**
1. **添加房间列表功能**
   - 显示所有等待中和准备中的房间
   - 实时刷新房间信息（每5秒）
   - 显示房间人数（如：3/10 人）

2. **优化UI显示**
   - 房间卡片显示状态徽章（等待中/准备中）
   - 使用不同颜色区分房间状态
   - 显示房间总数

3. **智能提示**
   - 有房间时：显示"加入房间"
   - 无房间时：显示"创建房间"

**修改的文件：**
- `miniprogram/pages/lobby/index.js`
  - 添加 `getAvailableRooms()` 方法
  - 添加房间列表轮询
  - 优化资源管理
- `miniprogram/pages/lobby/index.wxml`
  - 添加房间信息卡片UI
  - 显示房间列表
- `miniprogram/pages/lobby/index.wxss`
  - 添加房间卡片样式
  - 状态徽章样式
- `cloudfunctions/room/index.js`
  - 添加 `getAvailableRooms` action
  - 查询并返回可用房间列表

---

### Bug #2: 匹配成功后部分玩家卡在准备界面 ✅

**问题描述：**
- 匹配成功后，有些玩家能正常进入BP页面
- 部分玩家卡在房间准备界面
- 导致BP无法正常进行

**原因分析：**
1. **重复触发问题**
   - 所有玩家的轮询同时检测到 `status === 'ready'`
   - 每个玩家都尝试调用匹配云函数
   - 只有第一个调用成功的人跳转

2. **状态检测不完整**
   - 轮询只检测 `ready` 状态触发匹配
   - 没有检测 `bp` 状态来自动跳转
   - 导致后续玩家无法自动进入BP

**解决方案：**

1. **防止重复触发匹配**
   ```javascript
   // 添加 matchingStarted 标志
   if (room.status === 'ready' && !matchingStarted) {
     this.setData({ matchingStarted: true })
     this.onStartMatch()
   }
   ```

2. **检测BP状态自动跳转**
   ```javascript
   // 检测到BP状态，所有人自动跳转
   if (room.status === 'bp') {
     this.stopPolling()
     wx.redirectTo({
       url: `/pages/bp/index?room_id=${room_id}`
     })
   }
   ```

3. **移除直接跳转**
   - 匹配成功后不立即跳转
   - 依靠轮询检测 `bp` 状态
   - 确保所有玩家同步

**修改的文件：**
- `miniprogram/pages/lobby/index.js`
  - 添加 `matchingStarted` 防重复标志
  - 在 `getRoomStatus()` 中检测 `bp` 状态
  - 修改 `onStartMatch()` 移除直接跳转
  - 匹配失败时重置标志

**工作流程：**
```
1. 所有玩家准备 → 房间状态变为 'ready'
2. 第一个检测到的玩家触发匹配
3. 匹配云函数执行分队 → 房间状态变为 'matching'
4. BP云函数创建BP记录 → 房间状态变为 'bp'
5. 所有玩家的轮询检测到 'bp' → 自动跳转到BP页面
```

---

## 测试建议

### 测试场景1：房间列表显示
1. 打开小程序，进入大厅
2. 观察是否显示房间列表
3. 等待5秒，查看房间列表是否自动刷新
4. 点击加入房间

**预期结果：**
- 能看到所有等待中的房间
- 显示正确的人数
- 状态徽章正确显示

### 测试场景2：多人匹配跳转
1. 2-4人同时加入房间
2. 所有人点击准备
3. 观察是否所有人都能进入BP页面

**预期结果：**
- 所有玩家同步进入BP页面
- 没有人卡在准备界面
- BP页面正常显示

### 测试场景3：房间列表实时更新
1. 玩家A打开大厅（不加入）
2. 玩家B创建房间
3. 观察玩家A的大厅是否显示新房间

**预期结果：**
- 5秒内玩家A看到新房间
- 房间人数显示正确

---

## 部署说明

需要重新部署以下云函数：

```bash
cloudfunctions/room/  # 添加了 getAvailableRooms 功能
```

**部署步骤：**
1. 右键 `cloudfunctions/room` 目录
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成

---

## 技术细节

### 房间列表查询
```javascript
// 查询等待中和准备中的房间
db.collection('rooms').where({
  status: _.in(['waiting', 'ready'])
}).orderBy('created_at', 'desc').limit(10)
```

### 轮询机制优化
- **房间列表轮询**：每5秒（未加入房间时）
- **房间状态轮询**：每2秒（加入房间后）
- **自动清理**：离开房间或页面卸载时停止轮询

### 状态流转
```
waiting → ready → matching → bp → playing → finished
         ↑        ↑
      玩家准备   匹配完成
```

---

## 性能优化

1. **条件轮询**
   - 只在需要时轮询
   - 加入房间后停止房间列表轮询
   - 页面卸载时清理所有定时器

2. **数据最小化**
   - 房间列表只返回必要字段
   - 减少数据传输量

3. **查询优化**
   - 添加索引（status、created_at）
   - 限制返回数量（最多10个）

---

## 已知限制

1. 房间列表最多显示10个房间
2. 轮询间隔为5秒，可能有延迟
3. 不支持手动选择特定房间（自动匹配）

---

## 未来改进建议

1. **房间选择**：允许用户选择特定房间加入
2. **实时推送**：使用WebSocket代替轮询
3. **房间详情**：显示房间内玩家列表和平均ELO
4. **私密房间**：支持房间密码和好友房间
5. **房间筛选**：按人数、ELO范围筛选

