# CS2 内战匹配系统

一个基于微信小程序云开发的 CS2 内战匹配系统，支持玩家注册、ELO 匹配、地图 BP、比赛记录等功能。

## 🎯 功能特性

- ✅ 玩家注册与登录
- ✅ 退出登录功能
- ✅ 房间系统（自动匹配）
- ✅ ELO 平衡算法分队
- ✅ 地图 Ban/Pick 系统
- ✅ 比赛结果录入
- ✅ 自动 ELO 计算
- ✅ 历史战绩查询
- ✅ 排行榜系统

## 📁 项目结构

```
cs2/
├─ cloudfunctions/           # 云函数
│   ├─ login/               # 玩家登录
│   ├─ register/            # 玩家注册
│   ├─ room/                # 房间管理
│   ├─ match/               # 匹配分队
│   ├─ bp/                  # 地图 BP
│   ├─ submit/              # 提交结果
│   └─ history/             # 历史记录
├─ miniprogram/             # 小程序前端
│   ├─ pages/
│   │   ├─ login/           # 登录页面
│   │   ├─ register/        # 注册页面
│   │   ├─ lobby/           # 大厅页面（含退出功能）
│   │   ├─ bp/              # BP 页面
│   │   ├─ match/           # 比赛录入页面
│   │   ├─ history/         # 历史战绩页面
│   │   └─ ranking/         # 排行榜页面
│   └─ app.js
└─ docs/                    # 文档
    ├─ database.md          # 数据库设计
    └─ api.md               # API 文档
```

## 🚀 快速开始

### 1. 前置要求

- 微信开发者工具
- 已开通微信云开发环境

### 2. 安装步骤

1. 克隆项目到本地
2. 使用微信开发者工具打开项目
3. 在云开发控制台创建环境
4. 上传并部署所有云函数：
   - login
   - register
   - room
   - match
   - bp
   - submit
   - history

### 3. 数据库配置

在云开发控制台创建以下集合：

- `players` - 玩家表
- `rooms` - 房间表
- `bp_records` - BP 记录表
- `matches` - 比赛表
- `player_stats` - 玩家统计表
- `elo_history` - ELO 历史表

详细数据库结构请参考 [docs/database.md](docs/database.md)

### 4. 云函数部署

在每个云函数目录下执行：

```bash
npm install
```

然后在微信开发者工具中右键上传并部署。

## 🎮 使用流程

### 账号管理
1. **首次使用** - 进入登录页面，点击"立即注册"
2. **注册账号** - 输入昵称（可选 Steam ID）
3. **登录** - 已有账号可直接通过昵称登录
4. **退出登录** - 在大厅页面点击右上角"退出"按钮

### 游戏流程
1. **加入房间** - 自动加入或创建房间
2. **准备** - 等待所有玩家准备
3. **匹配** - 系统自动根据 ELO 平衡分队
4. **BP 地图** - A Ban → B Ban → A Pick
5. **比赛** - 进行游戏
6. **录入结果** - 输入比分和每位玩家的 KD
7. **计算 ELO** - 系统自动计算并更新 ELO
8. **查看战绩** - 查看个人历史和排行榜

## 📊 ELO 计算公式

```
期望胜率: P = 1 / (1 + 10^((对方ELO - 己方ELO) / 400))
ELO变化: ΔElo = K × (实际得分 - 期望得分)

K 因子:
- ELO < 1200: K = 40 (新手变化快)
- 1200 ≤ ELO ≤ 1800: K = 32 (正常)
- ELO > 1800: K = 24 (高手变化慢)

KD 修正:
- KD > 1.5: 额外 20% 加成
- KD < 0.8: 减少 20%
```

## 🗺️ 地图池与BP机制

当前支持的官方地图：

- Inferno
- Mirage
- Dust2
- Nuke
- Overpass
- Ancient
- Anubis

### BP流程
- **A队 Ban** → **B队 Ban** → **A队 Pick**
- **队内投票制**：需要队伍半数以上同意
- **实时同步**：所有玩家每2秒自动同步BP状态
- **权限控制**：只有当前轮到的队伍成员可以投票

## 📱 页面截图

（可以在此添加页面截图）

## 🔧 技术栈

- **前端**: 微信小程序
- **后端**: 微信云函数 (Node.js)
- **数据库**: 微信云数据库 (MongoDB)
- **算法**: ELO 评分系统

## 📝 文档

- [API 文档](docs/api.md) - 云函数接口说明
- [数据库设计](docs/database.md) - 数据库结构
- [实时同步更新](docs/REALTIME_SYNC_UPDATE.md) - 最新实时同步功能
- [BP功能更新说明](docs/BP_UPDATE.md) - BP功能修复详情
- [Bug修复文档](docs/BUG_FIX_v1.1.1.md) - v1.1.1修复详情

## 📅 更新日志

### v1.1.2 - 实时同步更新
**修复的Bug：**
- ✅ BP历史显示错误 - 修复变量名冲突
- ✅ 比赛录入数据独立 - 实现实时共享同步

**新增功能：**
- 比赛录入实时保存（1秒防抖）
- 比赛数据实时同步（2秒轮询）
- 所有玩家协同录入比赛结果
- 显示同步状态和时间
- BP页面调试信息显示

详细说明请查看 [实时同步更新文档](docs/REALTIME_SYNC_UPDATE.md)

### v1.1.1 - Bug修复更新
**修复的Bug：**
- ✅ 大厅页面看不到房间信息 - 添加房间列表显示
- ✅ 匹配后部分玩家卡住 - 优化自动跳转逻辑

**新增功能：**
- 显示可用房间列表和人数
- 房间状态实时刷新
- 房间状态徽章（等待中/准备中）

详细说明请查看 [Bug修复文档](docs/BUG_FIX_v1.1.1.md)

### v1.1.0 - BP功能重大更新
**修复的问题：**
- ✅ BP图不能同步 - 添加轮询机制实现实时同步
- ✅ 队伍权限混乱 - 只有当前队伍可以操作
- ✅ 单人点击即执行 - 改为队内投票制（需半数以上同意）

**其他改进：**
- 关闭个人测试模式（至少需要2人）
- 添加投票进度显示
- 优化视觉效果和提示信息

详细说明请查看 [BP更新文档](docs/BP_UPDATE.md)

## 🛠️ 后续计划

- [ ] Steam 登录绑定
- [ ] 赛季系统
- [ ] 更详细的数据统计
- [ ] 队伍固定匹配
- [ ] 自动从 CS2 服务器同步数据
- [ ] 赛后 MVP 评选
- [ ] Rating 2.0 评分系统

## 📄 License

MIT License

## 👥 贡献

欢迎提交 Issue 和 Pull Request！

## 📮 联系方式

如有问题请提交 Issue 或联系开发者。
